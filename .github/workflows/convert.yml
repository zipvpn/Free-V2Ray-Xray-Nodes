name: Auto Convert Subscription

# Trigger Conditions
on:
  push:
    paths:
      - 'free_v2ray_xray_nodes.txt' # Monitor changes to the specified file to automatically trigger the workflow
      - 'convert.py' # Monitor changes to the conversion script to automatically trigger the workflow
      - '.github/workflows/convert.yml' # Monitor changes to the workflow configuration to automatically trigger the workflow
  workflow_dispatch: # Allow manual triggering of the workflow

jobs:
  convert_and_push:
    runs-on: ubuntu-latest
  
    # Grant repository write permissions to allow committing generated subscription files
    permissions:
      contents: write
      
    steps:
    # 1. Checkout repository code to obtain the latest files
    - name: Checkout code
      uses: actions/checkout@v4
     
    # 2. Set up Python environment to run the conversion script
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
   
    # 3. Cache Subconverter components to avoid repeated downloads and prevent API rate limiting
    - name: Cache Subconverter
      id: cache-subconverter
      uses: actions/cache@v3
      with:
        path: subconverter
        key: ${{ runner.os }}-subconverter-cache-v1
   
    # 4. Install runtime dependencies to support network requests
    - name: Install dependencies
      run: |
        pip install requests
       
    # 5. Execute the subscription conversion script to generate target format files
    - name: Run Conversion Script
      run: |
        python convert.py
       
    # 6. Commit and push the generated subscription files to update the repository
    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
      
        # Add common subscription format files
        git add *.yaml *.json *.conf *.txt || true
      
        # Get staged changed subscription files
        changed_files=$(git diff-index --cached --name-only HEAD)
        
        if [ -z "$changed_files" ]; then
          echo "No changes to commit"
        else
          # Mapping from filename to client name
          declare -A file_to_client
          file_to_client[free_clash_nodes.yaml]="Clash"
          file_to_client[free_quantumultx_nodes.txt]="Quantumult X"
          file_to_client[free_surge_nodes.conf]="Surge"
          file_to_client[free_loon_nodes.conf]="Loon"
          file_to_client[free_surfboard_nodes.conf]="Surfboard"
          file_to_client[free_singbox_nodes.json]="sing-box"
          
          # Collect updated clients
          updated_clients=()
          for file in $changed_files; do
            client="${file_to_client[$file]}"
            if [ -n "$client" ]; then
              updated_clients+=("$client")
            fi
          done
          
          if [ ${#updated_clients[@]} -eq 0 ]; then
            client_list="subscription files"
          elif [ ${#updated_clients[@]} -eq 1 ]; then
            client_list="${updated_clients[0]} subscription nodes"
          else
            client_list="${updated_clients[0]}"
            for ((i=1; i<${#updated_clients[@]}-1; i++)); do
              client_list="${client_list}, ${updated_clients[$i]}"
            done
            client_list="${client_list}, and ${updated_clients[-1]} subscription nodes"
          fi
          
          # Get current time in PST/PDT (America/Los_Angeles timezone)
          TIME=$(TZ='America/Los_Angeles' date +"%Y-%m-%d %H:%M")
          
          # Final commit message (varies by which files actually changed)
          message="Update ${client_list} - ${TIME} [skip ci]"
          
          git commit -m "$message"
        
          # Pull latest remote code to avoid push conflicts
          git pull --rebase origin main || git pull --rebase origin master
        
          git push
        fi
