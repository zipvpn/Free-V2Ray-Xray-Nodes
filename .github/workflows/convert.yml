name: Auto Convert Subscription
# Trigger Configuration
on:
  # Trigger the workflow whenever changes (push operations) are detected in the following files
  push:
    paths:
      - 'free_v2ray_xray_nodes.txt'
 
  # Allow manual triggering from the Actions page
  workflow_dispatch:
jobs:
  convert_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allow reading and pushing code
      actions: write # Allow managing and deleting workflow runs
    steps:
    # --- Automatically delete old workflow runs ---
    - name: Delete old workflow runs
      continue-on-error: true
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 0
    # 1. Checkout code
    - name: Checkout code
      uses: actions/checkout@v4
    # 2. Set up Python environment
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    # 3. Cache Subconverter core (to avoid repeated downloads)
    - name: Cache Subconverter
      id: cache-subconverter
      uses: actions/cache@v4
      with:
        path: subconverter
        key: ${{ runner.os }}-subconverter-v0.7.2
    # 4. Install Python dependencies
    - name: Install dependencies
      run: |
        pip install requests
    # 5. Run conversion script
    - name: Run Conversion Script
      run: |
        python convert.py
    # --- Dynamically generate commit message and push ---
    - name: Commit and Push changes
      run: |
        # Configure Git user information
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
     
        # Add all possibly generated subscription files
        git add *.yaml *.json *.conf *.txt || true
     
        # Check if there are changes in the staging area; if none, skip commit
        if git diff-index --quiet HEAD --; then
          echo "No changes detected. Skipping commit."
          exit 0
        fi
     
        # Get the list of changed file names
        changed_files=$(git diff-index --cached --name-only HEAD)
       
        # Define mapping from file names to display names
        declare -A file_map
        file_map["free_clash_nodes.yaml"]="Clash"
        file_map["free_quantumultx_nodes.txt"]="Quantumult X"
        file_map["free_surge_nodes.conf"]="Surge"
        file_map["free_loon_nodes.conf"]="Loon"
        file_map["free_surfboard_nodes.conf"]="Surfboard"
        file_map["free_singbox_nodes.json"]="sing-box"
       
        # Iterate over changed files and collect corresponding client names
        clients=()
        for file in $changed_files; do
          if [ -n "${file_map[$file]}" ]; then
            clients+=("${file_map[$file]}")
          fi
        done
       
        # Build the client list portion of the commit message (e.g., "Clash, Loon, and Surge")
        count=${#clients[@]}
        client_list=""
       
        if [ $count -eq 0 ]; then
          client_list="subscription files"
        elif [ $count -eq 1 ]; then
          client_list="${clients[0]} subscription nodes"
        else
          # Concatenation logic to handle commas and "and"
          for (( i=0; i<count; i++ )); do
            if [ $i -eq 0 ]; then
              client_list="${clients[$i]}"
            elif [ $i -eq $((count-1)) ]; then
              client_list="$client_list, and ${clients[$i]} subscription nodes"
            else
              client_list="$client_list, ${clients[$i]}"
            fi
          done
        fi
       
        # Get current time
        TIME=$(TZ='America/Los_Angeles' date +"%Y-%m-%d %H:%M")
       
        # Compose the final commit message
        COMMIT_MSG="Update $client_list - $TIME"
        echo "Generated Commit Message: $COMMIT_MSG"
       
        # Commit changes
        git commit -m "$COMMIT_MSG"
       
        # Pull latest code (rebase) and push to prevent concurrent conflicts
        git pull --rebase origin main
        git push
